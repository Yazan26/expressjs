extends ../layout

block content
  .container.mt-4
    .row
      .col-md-12
        h2.mb-4 Browse Movies
        
        // Search and Filter Form
        .card.mb-4
          .card-body
            form(method='GET' action='/customer/movies')
              .row
                .col-md-4
                  .form-group
                    label(for='search') Search Movies
                    input.form-control(type='text' id='search' name='search' value=search placeholder='Search by title or description')
                
                .col-md-2
                  .form-group
                    label(for='category') Category
                    select.form-control(id='category' name='category')
                      option(value='all' selected=(category === 'all')) All Categories
                      each cat in categories
                        option(value=cat.name selected=(category === cat.name))= cat.name
                
                .col-md-2
                  .form-group
                    label(for='rating') Rating
                    select.form-control(id='rating' name='rating')
                      option(value='all' selected=(rating === 'all')) All Ratings
                      each r in ratings
                        option(value=r selected=(rating === r))= r
                
                .col-md-2
                  .form-group
                    label(for='available') Availability
                    select.form-control(id='available' name='available')
                      option(value='' selected=(!available)) All Movies
                      option(value='true' selected=(available === 'true')) Available Only
                
                .col-md-2
                  .form-group
                    label &nbsp;
                    button.btn.btn-primary.btn-block(type='submit') Search

        // Results
        if movies && movies.length > 0
          .row
            each movie in movies
              .col-md-4.mb-4
                .card.h-100
                  .card-body
                    h5.card-title= movie.title
                    p.card-text.text-muted= movie.category
                    p.card-text
                      small.text-muted Rating: #{movie.rating} | #{movie.length} min
                    p.card-text= movie.description.substring(0, 100) + '...'
                    .mt-auto
                      .d-flex.justify-content-between.align-items-center
                        .rental-info
                          strong $#{movie.rental_rate}
                          br
                          if movie.available_copies > 0
                            small.text-success #{movie.available_copies} available
                          else
                            small.text-danger Not available
                        .btn-group(role='group')
                          a.btn.btn-outline-primary.btn-sm(href=`/customer/movies/${movie.film_id}`) Details
                          if movie.available_copies > 0
                            form.d-inline(method='POST' action=`/customer/movies/${movie.film_id}/rent`)
                              button.btn.btn-success.btn-sm(type='submit') Rent
        else
          .alert.alert-info
            h4 No Movies Found
            p Try adjusting your search criteria or 
              a(href='/customer/movies') browse all movies
            
        // Pagination (if needed)
        if totalPages > 1
          nav(aria-label='Movie pagination')
            ul.pagination.justify-content-center
              if page > 1
                li.page-item
                  a.page-link(href=`/customer/movies?page=${page - 1}&search=${search}&category=${category}&rating=${rating}&available=${available}`) Previous
              
              - for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++)
                li.page-item(class=(i === page ? 'active' : ''))
                  a.page-link(href=`/customer/movies?page=${i}&search=${search}&category=${category}&rating=${rating}&available=${available}`)= i
              
              if page < totalPages
                li.page-item
                  a.page-link(href=`/customer/movies?page=${page + 1}&search=${search}&category=${category}&rating=${rating}&available=${available}`) Next

  script.
    // Add loading spinner to rental buttons
    document.addEventListener('DOMContentLoaded', function() {
      const rentalForms = document.querySelectorAll('form[action*="/rent"]');
      rentalForms.forEach(form => {
        form.addEventListener('submit', function() {
          const button = form.querySelector('button[type="submit"]');
          button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Renting...';
          button.disabled = true;
        });
      });
    });