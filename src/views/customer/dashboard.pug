extends ../layout

block content
  .container.mt-4
    .row
      .col-md-12
        h1.mb-4 Customer Dashboard
        if user
          h5.text-muted Welcome back, #{user.username} #{user.last_name}!
    
    .row
      // Active Rentals
      .col-md-8
        .card.mb-4
          .card-header
            .d-flex.justify-content-between.align-items-center
              h5.mb-0 Active Rentals
              span.badge.badge-primary= activeRentals ? activeRentals.length : 0
          .card-body
            if activeRentals && activeRentals.length > 0
              .table-responsive
                table.table.table-hover
                  thead
                    tr
                      th Movie
                      th Rented Date
                      th Due Date
                      th Pricing Rate
                      th Status
                      th Action
                  tbody
                    each rental in activeRentals
                      tr(class=(rental.is_overdue ? 'table-danger' : ''))
                        td
                          strong= rental.title
                          br
                          small.text-muted= rental.category
                        td= new Date(rental.rental_date).toLocaleDateString()
                        td= new Date(rental.due_date).toLocaleDateString()
                        td.text-success $#{rental.rental_rate}
                        td
                          if rental.is_overdue
                            span.text-danger Overdue
                          else
                            span.text-success Active
                        td
                          .btn-group(role="group")
                            a.btn.btn-sm.btn-outline-primary(href=`/customer/movies/${rental.film_id}`) View Details
                            if !rental.is_overdue
                              form.d-inline(method="POST" action=`/customer/rentals/${rental.rental_id}/cancel` onsubmit="return confirmCancel()")
                                button.btn.btn-sm.btn-outline-danger(type="submit" id=`cancelBtn-${rental.rental_id}`) Cancel
              
              if summary.total_overdue > 0
                .alert.alert-warning.mt-3
                  strong #{summary.total_overdue} overdue rental(s)
                  p Please return these movies as soon as possible to avoid additional fees.
            else
              .text-center.py-4
                p.text-muted No active rentals
                a.btn.btn-primary(href='/customer/movies') Browse Movies
      
      // Summary and Quick Actions
      .col-md-4
        // Rental Summary
        .card.mb-4
          .card-header
            h5.mb-0 Rental Summary
          .card-body
            if summary
              .d-flex.justify-content-between
                span Total Active:
                strong= summary.total_active
              .d-flex.justify-content-between
                span Overdue:
                strong.text-danger= summary.total_overdue
              .d-flex.justify-content-between
                span This Month Cost:
                strong $#{summary.current_month_total.toFixed(2)}
              hr
              .d-flex.justify-content-between
                span Total Spent:
                strong.text-success $#{summary.total_spent.toFixed(2)}
        
        // Quick Actions
        .card.mb-4
          .card-header
            h5.mb-0 Quick Actions
          .card-body
            .d-grid.gap-2
              a.btn.btn-primary(href='/customer/movies') Browse Movies
              a.btn.btn-outline-secondary(href='/customer/spending') Spending History
              a.btn.btn-outline-info(href='/customer/profile') My Profile
              hr
              a.btn.btn-outline-danger(href='/auth/logout') Logout

  


    // Recommendations Section
    if recommendations && (recommendations.byCategory.length > 0 || recommendations.byActor.length >  0)
      .row
        .col-12
          h4.mb-3 You Might Also Like
          
          if recommendations.byCategory.length > 0
            h5.text-muted.mb-3
              i.fas.fa-th-large.me-2
              | More Films in Your Favorite Categories
            
            .row.mb-4
              each rec in recommendations.byCategory.slice(0, 4)
                .col-md-3.col-sm-6.mb-3
                  .card.recommendation-card.h-100
                    .card-body.p-3
                      h6.card-title
                        a.text-decoration-none(href=`/films/${rec.film_id}`) #{rec.title}
                      if rec.release_year
                        .small.text-muted.mb-2 #{rec.release_year}
                      if rec.rating
                        span.badge.bg-secondary.badge-sm #{rec.rating}
                      if rec.category
                        .small.text-muted #{rec.category}
                      .d-flex.justify-content-between.align-items-center.mt-2
                        span.text-success
                          strong $#{rec.rental_rate}
                        if rec.available_copies > 0
                          small.text-success Available
                        else
                          small.text-danger Rented
          
          if recommendations.byActor.length > 0
            h5.text-muted.mb-3.mt-4
              i.fas.fa-user.me-2
              | More Films with Same Actors
            
            .row
              each rec in recommendations.byActor.slice(0, 4)
                .col-md-3.col-sm-6.mb-3
                  .card.recommendation-card.h-100
                    .card-body.p-3
                      h6.card-title
                        a.text-decoration-none(href=`/films/${rec.film_id}`) #{rec.title}
                      if rec.release_year
                        .small.text-muted.mb-2 #{rec.release_year}
                      if rec.rating
                        span.badge.bg-secondary.badge-sm #{rec.rating}
                      if rec.category
                        .small.text-muted #{rec.category}
                      .d-flex.justify-content-between.align-items-center.mt-2
                        span.text-success
                          strong $#{rec.rental_rate}
                        if rec.available_copies > 0
                          small.text-success Available
                        else
                          small.text-danger Rented  
    script.
        function confirmCancel() {
          return confirm('Are you sure you want to cancel this rental? This action cannot be undone.');
        }
        
        // Add loading spinners to cancel buttons
        document.addEventListener('DOMContentLoaded', function() {
          const cancelForms = document.querySelectorAll('form[action*="/cancel"]');
          cancelForms.forEach(form => {
            form.addEventListener('submit', function(e) {
              const button = form.querySelector('button[type="submit"]');
              if (button) {
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Canceling...';
                button.disabled = true;
              }
            });
          });
        });