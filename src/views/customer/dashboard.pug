extends ../layout

block content
  section.mx-section.pt-0.mb-5
    h1.h3.fw-semibold.mb-1 Customer dashboard
    if user
      p.text-muted.mb-4 Welcome back, #{user.username} #{user.last_name}! Let's pick up where you left off.
    .row.g-4
      .col-lg-8
        .mx-card.h-100
          .p-4
            .d-flex.justify-content-between.align-items-center.mb-3
              h2.h5.fw-semibold.mb-0 Active rentals
              span.badge.mx-pill.mx-pill-soft.fw-semibold #{activeRentals ? activeRentals.length : 0}
            if activeRentals && activeRentals.length > 0
              .table-responsive.mx-table
                table.table.table-dark.table-hover.align-middle.mb-0
                  thead
                    tr
                      th(scope='col') Title
                      th(scope='col') Rented
                      th(scope='col') Due
                      th(scope='col') Rate
                      th(scope='col') Status
                      th(scope='col' class='text-end') Actions
                  tbody
                    each rental in activeRentals
                      - const overdue = rental.is_overdue;
                      tr(class=overdue ? 'table-danger' : '')
                        td
                          strong= rental.title
                          if rental.category
                            br
                            small.text-muted #{rental.category}
                        td= new Date(rental.rental_date).toLocaleDateString()
                        td= new Date(rental.due_date).toLocaleDateString()
                        td.text-success $#{rental.rental_rate}
                        td
                          if overdue
                            span.badge.badge-soft.text-danger Overdue
                          else
                            span.badge.badge-soft.text-success Active
                        td.text-end
                          .btn-group(role='group')
                            a.btn.btn-sm.btn-outline-accent.rounded-pill(href=`/customer/movies/${rental.film_id}`)
                              i.fas.fa-eye.me-2
                              | Details
                            if !overdue
                              form.d-inline(method='POST' action=`/customer/rentals/${rental.rental_id}/cancel` onsubmit='return confirmCancel()')
                                button.btn.btn-sm.btn-outline-danger.rounded-pill(type='submit' id=`cancelBtn-${rental.rental_id}`)
                                  i.fas.fa-xmark.me-1
                                  | Cancel
              if summary && summary.total_overdue > 0
                .alert.alert-warning.border-0.mt-3
                  strong #{summary.total_overdue} overdue rental(s).
                  span.ms-2 Please return these titles soon to avoid additional fees.
            else
              .text-center.py-5
                i.fas.fa-film.fa-2x.text-muted.mb-3
                p.text-muted.mb-3 No active rentals yet - why not start one now?
                a.btn.btn-accent.rounded-pill.px-4(href='/customer/movies')
                  i.fas.fa-compass.me-2
                  | Browse movies
      .col-lg-4
        // NOTE: Removed h-100 to avoid forcing this card to stretch and causing footer overlap issues on some viewports.
        .mx-card
          .p-4
            h2.h5.fw-semibold.mb-3 Rental summary
            if summary
              .d-flex.justify-content-between.align-items-center.mb-2
                span.text-muted Active rentals
                strong= summary.total_active
              .d-flex.justify-content-between.align-items-center.mb-2
                span.text-muted Overdue
                strong.text-danger= summary.total_overdue
              .d-flex.justify-content-between.align-items-center.mb-2
                span.text-muted This month
                strong $#{summary.current_month_total.toFixed(2)}
              hr
              .d-flex.justify-content-between.align-items-center
                span.text-muted spendings
                strong.text-success $#{summary.total_spent.toFixed(2)}
        // NOTE: Removed h-100 here as well; added mb-5 for extra spacing above footer.
        .mx-card.mt-4.mt-lg-0.mb-5
          .p-4
            h2.h5.fw-semibold.mb-3 Quick actions
            .vstack.gap-3
              a.btn.btn-outline-accent.rounded-pill.px-4(href='/customer/movies')
                i.fas.fa-film.me-2
                | Browse catalog
              a.btn.btn-outline-light.rounded-pill.px-4(href='/customer/spending')
                i.fas.fa-chart-line.me-2
                | Spending history
              a.btn.btn-outline-light.rounded-pill.px-4(href='/customer/profile')
                i.fas.fa-user-gear.me-2
                | Manage profile
              form(action='/auth/logout' method='POST')
                button.btn.btn-outline-danger.rounded-pill.px-4.w-100(type='submit')
                  i.fas.fa-right-from-bracket.me-2
                  | Logout

  if recommendations && (recommendations.byCategory.length > 0 || recommendations.byActor.length > 0)
    section.mx-section.pt-0.mb-5
      h2.h4.fw-semibold.mb-3 You might also like
      if recommendations.byCategory.length > 0
        h3.h6.text-uppercase.text-muted.mb-3
          i.fas.fa-th-large.me-2
          | Films in your favourite categories
        .row.row-cols-1.row-cols-sm-2.row-cols-lg-4.g-3.mb-4
          each rec in recommendations.byCategory.slice(0, 4)
            .col
              .mx-card.h-100.p-4.shadow-hover
                h5.fw-semibold.mb-2
                  a.text-decoration-none(href=`/films/${rec.film_id}`)= rec.title
                if rec.release_year
                  p.text-muted.small.mb-2 #{rec.release_year}
                if rec.rating
                  span.badge.mx-pill.mx-pill-soft #{rec.rating}
                if rec.category
                  p.text-muted.small.mb-3 #{rec.category}
                .d-flex.justify-content-between.align-items-center
                  span.text-success.fw-semibold $#{rec.rental_rate}
                  if rec.available_copies > 0
                    span.badge.bg-success.bg-opacity-25.text-success Available
                  else
                    span.badge.bg-danger.bg-opacity-25.text-danger Rented out
      if recommendations.byActor.length > 0
        h3.h6.text-uppercase.text-muted.mt-4.mb-3
          i.fas.fa-user.me-2
          | Films featuring your favorite actors
        .row.row-cols-1.row-cols-sm-2.row-cols-lg-4.g-3
          each rec in recommendations.byActor.slice(0, 4)
            .col
              .mx-card.h-100.p-4.shadow-hover
                h5.fw-semibold.mb-2
                  a.text-decoration-none(href=`/films/${rec.film_id}`)= rec.title
                if rec.release_year
                  p.text-muted.small.mb-2 #{rec.release_year}
                if rec.rating
                  span.badge.mx-pill.mx-pill-soft #{rec.rating}
                if rec.category
                  p.text-muted.small.mb-3 #{rec.category}
                .d-flex.justify-content-between.align-items-center
                  span.text-success.fw-semibold $#{rec.rental_rate}
                  if rec.available_copies > 0
                    span.badge.bg-success.bg-opacity-25.text-success Available
                  else
                    span.badge.bg-danger.bg-opacity-25.text-danger Rented out

  script.
    function confirmCancel() {
      return confirm('Are you sure you want to cancel this rental? This action cannot be undone.');
    }
    document.addEventListener('DOMContentLoaded', function () {
      const cancelForms = document.querySelectorAll('form[action*="/cancel"]');
      cancelForms.forEach(function (form) {
        form.addEventListener('submit', function () {
          const button = form.querySelector('button[type="submit"]');
          if (button) {
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Canceling';
            button.disabled = true;
          }
        });
      });
    });
