extends ../layout

block content
  section.mx-section.pt-0
    a.btn.btn-outline-light.btn-sm.rounded-pill.mb-3(href='/customer/dashboard')
      i.fas.fa-arrow-left.me-2
      | Back to dashboard
    .d-flex.flex-wrap.align-items-center.justify-content-between.mb-4
      div
        h1.h3.fw-semibold.mb-1
          i.fas.fa-chart-line.me-2.text-success
          | Spending history
        p.text-muted.mb-0 Explore your rental activity and investments over time.
      .btn-group
        a.btn.btn-outline-accent.rounded-pill(href='/customer/dashboard') Dashboard
        a.btn.btn-outline-light.rounded-pill(href='/customer/movies') Browse movies
  
  section.mx-section.pt-0
    .mx-card.p-4
      h2.h6.text-uppercase.text-muted.mb-3
        i.fas.fa-calendar-days.me-2
        | Filter by period
      form.row.g-3(method='GET' action='/customer/spending')
        .col-md-6
          select.form-select.form-select-lg(name='period')
            option(value='all' selected=currentPeriod === 'all') All time
            option(value='30' selected=currentPeriod === '30') Last 30 days
            option(value='90' selected=currentPeriod === '90') Last 3 months
            - const now = new Date()
            - for (let i = 0; i < 12; i++)
              - const date = new Date(now.getFullYear(), now.getMonth() - i, 1)
              - const value = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0')
              option(value=value selected=currentPeriod === value) #{date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}
        .col-md-3
          button.btn.btn-accent.btn-lg.rounded-pill(type='submit')
            i.fas.fa-filter.me-2
            | Apply filters

  if summary
    section.mx-section.pt-0
      .row.g-4
        .col-md-4
          .mx-card.h-100.p-4.text-center
            span.rounded-circle.bg-light.bg-opacity-10.d-inline-flex.align-items-center.justify-content-center.mb-3(style='width:64px;height:64px;')
              i.fas.fa-sack-dollar.fa-lg.text-success
            h3.h5.fw-semibold.mb-2 $#{summary.totalAmount || '0.00'}
            p.text-muted.small.mb-0 Total spent #{summary.period !== 'all' ? 'in selected period' : 'overall'}
        .col-md-4
          .mx-card.h-100.p-4.text-center
            span.rounded-circle.bg-light.bg-opacity-10.d-inline-flex.align-items-center.justify-content-center.mb-3(style='width:64px;height:64px;')
              i.fas.fa-bag-shopping.fa-lg.text-info
            h3.h5.fw-semibold.mb-2 #{summary.totalRentals || 0}
            p.text-muted.small.mb-0 Rentals completed
        .col-md-4
          .mx-card.h-100.p-4.text-center
            span.rounded-circle.bg-light.bg-opacity-10.d-inline-flex.align-items-center.justify-content-center.mb-3(style='width:64px;height:64px;')
              i.fas.fa-calculator.fa-lg.text-warning
            - const average = summary.totalRentals > 0 ? (Number(summary.totalAmount || 0) / summary.totalRentals).toFixed(2) : '0.00'
            h3.h5.fw-semibold.mb-2 $#{average}
            p.text-muted.small.mb-0 Average spend per rental

  if spending && spending.length > 0
    section.mx-section.pt-0
      .mx-card
        .p-4
          h2.h5.fw-semibold.mb-3
            i.fas.fa-list-ul.me-2
            | Transaction history
        .table-responsive.mx-table
          table.table.table-dark.table-hover.align-middle.mb-0
            thead
              tr
                th(scope='col') Payment date
                th(scope='col') Film title
                th(scope='col') Rating
                th(scope='col') Amount
                th(scope='col') Rental date
                th(scope='col') Status
            tbody
              each transaction in spending
                tr
                  td= new Date(transaction.payment_date).toLocaleDateString()
                  td
                    strong
                      a.text-decoration-none(href=/customer/movies/)= transaction.title
                  td
                    if transaction.rating
                      span.badge.mx-pill.mx-pill-soft #{transaction.rating}
                    else
                      span.text-muted.small N/A
                  td.text-success.fw-semibold
                    | $#{Number(transaction.amount).toFixed(2)}
                  td.text-muted= new Date(transaction.rental_date).toLocaleDateString()
                  td
                    if transaction.return_date
                      span.badge.bg-success.bg-opacity-25.text-success Returned
                    else
                      span.badge.bg-primary.bg-opacity-25.text-primary Active
  else
    section.mx-section.pt-0
      .mx-card.p-5.text-center
        i.fas.fa-chart-line.fa-3x.text-muted.mb-3
        h2.h5.fw-semibold.mb-2 No spending history yet
        if currentPeriod && currentPeriod !== 'all'
          p.text-muted.mb-4 No transactions found for the selected period.
        else
          p.text-muted.mb-4 You have not completed any rentals yet.
        .d-flex.justify-content-center.gap-3
          if currentPeriod && currentPeriod !== 'all'
            a.btn.btn-outline-accent.rounded-pill.px-4(href='/customer/spending')
              i.fas.fa-clock-rotate-left.me-2
              | View all time
          a.btn.btn-accent.rounded-pill.px-4(href='/customer/movies')
            i.fas.fa-film.me-2
            | Browse movies

  section.mx-section.pt-0
    .mx-card.p-4
      h2.h6.text-uppercase.text-muted.mb-3 Quick actions
      .row.g-3
        .col-sm-6.col-md-3
          a.btn.btn-outline-accent.w-100.rounded-pill(href='/customer/dashboard')
            i.fas.fa-gauge-high.me-2
            | Dashboard
        .col-sm-6.col-md-3
          a.btn.btn-outline-light.w-100.rounded-pill(href='/customer/movies')
            i.fas.fa-film.me-2
            | Browse movies
        .col-sm-6.col-md-3
          a.btn.btn-outline-light.w-100.rounded-pill(href='/customer/spending')
            i.fas.fa-rotate.me-2
            | Refresh data
        .col-sm-6.col-md-3
          a.btn.btn-outline-light.w-100.rounded-pill(href='/customer/profile')
            i.fas.fa-user.me-2
            | Profile
