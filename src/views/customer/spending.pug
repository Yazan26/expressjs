extends ../layout

block content
  .container-fluid
    // Flash Messages
    if messages.error
      .alert.alert-danger.alert-dismissible.fade.show
        i.fas.fa-exclamation-triangle.me-2
        | #{messages.error}
        button.btn-close(type="button", data-bs-dismiss="alert")

    if messages.success
      .alert.alert-success.alert-dismissible.fade.show
        i.fas.fa-check-circle.me-2
        | #{messages.success}
        button.btn-close(type="button", data-bs-dismiss="alert")

    // Back Navigation
    .mb-3
      a.btn.btn-outline-secondary(href="/customer/dashboard")
        i.fas.fa-arrow-left.me-2
        | Back to Dashboard

    .row.mb-4
      .col-lg-8
        h1.h2.mb-1
          i.fas.fa-chart-line.me-2.text-success
          | Spending History
        p.text-muted Here's a breakdown of your rental spending over time
      
      .col-lg-4.text-lg-end
        .btn-group
          a.btn.btn-outline-primary(href="/customer/dashboard") Dashboard
          a.btn.btn-outline-info(href="/customer/movies") Browse Movies

    // Period Selector
    .row.mb-4
      .col-12
        .card
          .card-header
            h5.card-title.mb-0
              i.fas.fa-calendar.me-2
              | Filter by Period
          
          .card-body
            form.row.g-3(method="GET", action="/customer/spending")
              .col-md-6
                select.form-select(name="period")
                  option(value="all", selected=currentPeriod === 'all') All Time
                  option(value="30", selected=currentPeriod === '30') Last 30 Days
                  option(value="90", selected=currentPeriod === '90') Last 3 Months
                  - const now = new Date()
                  - for (let i = 0; i < 12; i++)
                    - const date = new Date(now.getFullYear(), now.getMonth() - i, 1)
                    - const value = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0')
                    option(value=value, selected=currentPeriod === value) #{date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}
              
              .col-md-3
                button.btn.btn-primary(type="submit")
                  i.fas.fa-search.me-2
                  | Filter

    // Summary Cards
    if summary
      .row.mb-4
        .col-md-4.mb-3
          .card.border-success.h-100
            .card-body.text-center
              .display-6.text-success.mb-2
                i.fas.fa-dollar-sign
              h4.card-title $#{summary.totalAmount || '0.00'}
              p.card-text.text-muted Total Spent
              if summary.period !== 'all'
                small.text-muted in selected period
        
        .col-md-4.mb-3
          .card.border-info.h-100
            .card-body.text-center
              .display-6.text-info.mb-2
                i.fas.fa-shopping-bag
              h4.card-title #{summary.totalRentals || 0}
              p.card-text.text-muted Total Rentals
        
        .col-md-4.mb-3
          .card.border-warning.h-100
            .card-body.text-center
              .display-6.text-warning.mb-2
                i.fas.fa-calculator
              h4.card-title 
                if summary.totalRentals > 0
                  | $#{(parseFloat(summary.totalAmount || 0) / summary.totalRentals).toFixed(2)}
                else
                  | $0.00
              p.card-text.text-muted Average per Rental

    // Spending Details
    if spending && spending.length > 0
      .row
        .col-12
          .card
            .card-header
              h5.card-title.mb-0
                i.fas.fa-list-alt.me-2
                | Transaction History

            .card-body
              .table-responsive
                table.table.table-hover
                  thead.table-light
                    tr
                      th Payment Date
                      th Film Title
                      th Rating
                      th Amount
                      th Rental Date
                      th Status
                  
                  tbody
                    each transaction in spending
                      tr
                        td #{new Date(transaction.payment_date).toLocaleDateString()}
                        td
                          strong
                            a.text-decoration-none(href=`/customer/movies/${transaction.film_id || '#'}`) #{transaction.title}
                        td
                          if transaction.rating
                            span.badge.bg-secondary #{transaction.rating}
                          else
                            span.text-muted.small N/A
                        td.text-success.fw-bold $#{parseFloat(transaction.amount).toFixed(2)}
                        td.text-muted #{new Date(transaction.rental_date).toLocaleDateString()}
                        td
                          if transaction.return_date
                            span.badge.bg-success Returned
                          else
                            span.badge.bg-primary Active

    else
      // Empty State
      .row
        .col-12
          .card
            .card-body.text-center.py-5
              .mb-4
                i.fas.fa-chart-line.fa-4x.text-muted
              h4.text-muted No Spending History
              p.text-muted.mb-4
                if currentPeriod && currentPeriod !== 'all'
                  | No transactions found for the selected time period.
                else
                  | You haven't made any rental payments yet.
              
              .d-flex.gap-2.justify-content-center
                if currentPeriod && currentPeriod !== 'all'
                  a.btn.btn-outline-primary(href="/customer/spending") View All Time
                a.btn.btn-primary(href="/customer/movies")
                  i.fas.fa-film.me-2
                  | Browse Movies

    // Quick Actions
    .row.mt-4
      .col-12
        .card.bg-light
          .card-body
            h6.card-title
              i.fas.fa-bolt.me-2
              | Quick Actions
            .row
              .col-md-3.mb-2
                a.btn.btn-outline-primary.w-100(href="/customer/dashboard")
                  i.fas.fa-tachometer-alt.me-2
                  | Dashboard
              
              .col-md-3.mb-2
                a.btn.btn-outline-success.w-100(href="/customer/movies")
                  i.fas.fa-film.me-2
                  | Browse Movies
              
              .col-md-3.mb-2
                a.btn.btn-outline-info.w-100(href="/customer/spending")
                  i.fas.fa-refresh.me-2
                  | Refresh Data
              
              .col-md-3.mb-2
                a.btn.btn-outline-secondary.w-100(href="/customer/profile")
                  i.fas.fa-user.me-2
                  | My Profile

style.
  .card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
  }
  .card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.2s;
  }
  .table th {
    border-top: none;
    font-weight: 600;
  }