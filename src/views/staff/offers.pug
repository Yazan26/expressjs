extends ../layout

block content
  .container-fluid
    // Page Header
    .row.mb-4
      .col-lg-8
        h1.h2.mb-1
          i.fas.fa-tags.me-2.text-warning
          | Staff Film Offers
        p.text-muted Manage and select from available film offers
      
      .col-lg-4.text-lg-end
        .btn-group
          if user && (user.role === 'manager' || user.role === 'admin')
            a.btn.btn-outline-success(href="/admin/offers")
              i.fas.fa-plus.me-2
              | Manage Offers
          a.btn.btn-outline-info(href="/reports") 
            i.fas.fa-chart-bar.me-2
            | Reports

    // Success/Error Messages
    if success
      .alert.alert-success.alert-dismissible.fade.show
        i.fas.fa-check-circle.me-2
        | #{success}
        button.btn-close(type="button", data-bs-dismiss="alert")

    if error
      .alert.alert-danger.alert-dismissible.fade.show
        i.fas.fa-exclamation-triangle.me-2
        | #{error}
        button.btn-close(type="button", data-bs-dismiss="alert")

    // Filters
    .row.mb-4
      .col-12
        .card
          .card-header
            h5.card-title.mb-0
              i.fas.fa-filter.me-2
              | Filter Offers
          
          .card-body
            form.row.g-3(method="GET", action="/staff/offers")
              .col-md-3
                label.form-label Category
                select.form-select(name="category")
                  option(value="", selected=!selectedCategory) All Categories
                  if categories
                    each category in categories
                      option(value=category.name, selected=selectedCategory === category.name) #{category.name}
              
              .col-md-3
                label.form-label Status
                select.form-select(name="status")
                  option(value="", selected=!selectedStatus) All Status
                  option(value="active", selected=selectedStatus === 'active') Active
                  option(value="expired", selected=selectedStatus === 'expired') Expired
                  option(value="coming_soon", selected=selectedStatus === 'coming_soon') Coming Soon
              
              .col-md-3
                label.form-label Sort By
                select.form-select(name="sort")
                  option(value="newest", selected=selectedSort === 'newest') Newest First
                  option(value="oldest", selected=selectedSort === 'oldest') Oldest First
                  option(value="discount", selected=selectedSort === 'discount') Highest Discount
                  option(value="title", selected=selectedSort === 'title') Title A-Z
              
              .col-md-3.d-flex.align-items-end
                button.btn.btn-primary.w-100(type="submit")
                  i.fas.fa-search.me-2
                  | Apply Filters

    // Offers List
    if offers && offers.length > 0
      .row
        each offer in offers
          .col-lg-6.col-xl-4.mb-4
            .card.h-100(class=offer.status === 'expired' ? 'border-danger' : offer.status === 'coming_soon' ? 'border-warning' : 'border-success')
              // Offer Status Badge
              .position-relative
                if offer.status === 'expired'
                  .position-absolute.top-0.end-0.m-2
                    .badge.bg-danger Expired
                else if offer.status === 'coming_soon'
                  .position-absolute.top-0.end-0.m-2
                    .badge.bg-warning Coming Soon
                else
                  .position-absolute.top-0.end-0.m-2
                    .badge.bg-success Active

              .card-header
                .d-flex.justify-content-between.align-items-start
                  h5.card-title.mb-1 #{offer.filmTitle}
                  if offer.discountPercent
                    .badge.bg-primary.fs-6 #{offer.discountPercent}% OFF
              
              .card-body
                .row.mb-3
                  .col-6
                    .small.text-muted Category
                    .fw-bold #{offer.categoryName}
                  .col-6
                    .small.text-muted Rating
                    .fw-bold #{offer.rating}
                
                if offer.description
                  p.card-text.small.text-muted #{offer.description.substring(0, 100)}#{offer.description.length > 100 ? '...' : ''}
                
                // Pricing
                .row.mb-3
                  .col-6
                    .small.text-muted Original Price
                    .fw-bold $#{parseFloat(offer.originalPrice || 0).toFixed(2)}
                  .col-6
                    .small.text-muted Offer Price
                    .fw-bold.text-success $#{parseFloat(offer.offerPrice || 0).toFixed(2)}
                
                // Dates
                .row.mb-3
                  .col-6
                    .small.text-muted Valid From
                    .small #{new Date(offer.startDate).toLocaleDateString()}
                  .col-6
                    .small.text-muted Valid Until
                    .small #{new Date(offer.endDate).toLocaleDateString()}
                
                // Action Buttons
                .d-flex.gap-2
                  if offer.status === 'active'
                    form(method="POST", action="/staff/offers/select", style="display:inline;")
                      input(type="hidden", name="offerId", value=offer.offerId)
                      button.btn.btn-success.btn-sm(type="submit")
                        i.fas.fa-check.me-1
                        | Select Offer
                  
                  a.btn.btn-outline-info.btn-sm(href=`/films/${offer.filmId}`)
                    i.fas.fa-eye.me-1
                    | View Film
                
                // Selection Count
                if offer.selectedCount > 0
                  .mt-2
                    .small.text-muted
                      i.fas.fa-users.me-1
                      | #{offer.selectedCount} staff member#{offer.selectedCount !== 1 ? 's' : ''} selected this offer

      // Pagination
      if pagination && pagination.totalPages > 1
        .row.mt-4
          .col-12
            .d-flex.justify-content-center
              nav
                ul.pagination
                  if pagination.currentPage > 1
                    li.page-item
                      a.page-link(href=`?page=${pagination.currentPage - 1}&category=${selectedCategory || ''}&status=${selectedStatus || ''}&sort=${selectedSort || ''}`)
                        i.fas.fa-chevron-left
                  
                  - var startPage = Math.max(1, pagination.currentPage - 2)
                  - var endPage = Math.min(pagination.totalPages, pagination.currentPage + 2)
                  
                  if startPage > 1
                    li.page-item
                      a.page-link(href=`?page=1&category=${selectedCategory || ''}&status=${selectedStatus || ''}&sort=${selectedSort || ''}`) 1
                    if startPage > 2
                      li.page-item.disabled
                        span.page-link ...
                  
                  - for (var i = startPage; i <= endPage; i++)
                    li.page-item(class=i === pagination.currentPage ? 'active' : '')
                      if i === pagination.currentPage
                        span.page-link #{i}
                      else
                        a.page-link(href=`?page=${i}&category=${selectedCategory || ''}&status=${selectedStatus || ''}&sort=${selectedSort || ''}`) #{i}
                  
                  if endPage < pagination.totalPages
                    if endPage < pagination.totalPages - 1
                      li.page-item.disabled
                        span.page-link ...
                    li.page-item
                      a.page-link(href=`?page=${pagination.totalPages}&category=${selectedCategory || ''}&status=${selectedStatus || ''}&sort=${selectedSort || ''}`) #{pagination.totalPages}
                  
                  if pagination.currentPage < pagination.totalPages
                    li.page-item
                      a.page-link(href=`?page=${pagination.currentPage + 1}&category=${selectedCategory || ''}&status=${selectedStatus || ''}&sort=${selectedSort || ''}`)
                        i.fas.fa-chevron-right

    else
      // Empty State
      .row
        .col-12
          .card
            .card-body.text-center.py-5
              .mb-4
                i.fas.fa-tags.fa-4x.text-muted
              h4.text-muted No Offers Available
              p.text-muted.mb-4
                if selectedCategory || selectedStatus
                  | No offers found matching your filter criteria.
                else
                  | There are currently no film offers available.
              
              .d-flex.gap-2.justify-content-center
                if selectedCategory || selectedStatus
                  a.btn.btn-outline-primary(href="/staff/offers") View All Offers
                if user && (user.role === 'manager' || user.role === 'admin')
                  a.btn.btn-primary(href="/admin/offers")
                    i.fas.fa-plus.me-2
                    | Create Offers

    // My Selections
    if mySelections && mySelections.length > 0
      .row.mt-5
        .col-12
          .card
            .card-header
              h5.card-title.mb-0
                i.fas.fa-star.me-2.text-warning
                | My Selected Offers
                span.badge.bg-primary.ms-2 #{mySelections.length}
            
            .card-body
              .row
                each selection in mySelections
                  .col-md-6.col-lg-4.mb-3
                    .card.border-success.bg-light
                      .card-body
                        .d-flex.justify-content-between.align-items-start.mb-2
                          h6.card-title.mb-0 #{selection.filmTitle}
                          .badge.bg-success.text-nowrap Selected
                        
                        .d-flex.justify-content-between.align-items-center.mb-2
                          .small.text-muted Offer Price
                          .fw-bold.text-success $#{parseFloat(selection.offerPrice).toFixed(2)}
                        
                        .d-flex.justify-content-between.align-items-center.mb-2
                          .small.text-muted Selected On
                          .small #{new Date(selection.selectedDate).toLocaleDateString()}
                        
                        .d-flex.gap-1
                          a.btn.btn-outline-info.btn-sm(href=`/films/${selection.filmId}`)
                            i.fas.fa-eye.me-1
                            | View
                          
                          form(method="POST", action="/staff/offers/unselect", style="display:inline;")
                            input(type="hidden", name="offerId", value=selection.offerId)
                            button.btn.btn-outline-danger.btn-sm(type="submit")
                              i.fas.fa-times.me-1
                              | Remove

    // Quick Actions
    .row.mt-4
      .col-12
        .card.bg-light
          .card-body
            h6.card-title
              i.fas.fa-bolt.me-2
              | Quick Actions
            .row
              .col-md-3.mb-2
                a.btn.btn-outline-primary.w-100(href="/staff/offers")
                  i.fas.fa-refresh.me-2
                  | Refresh Offers
              
              .col-md-3.mb-2
                a.btn.btn-outline-info.w-100(href="/films")
                  i.fas.fa-film.me-2
                  | Browse Films
              
              if user && (user.role === 'manager' || user.role === 'admin')
                .col-md-3.mb-2
                  a.btn.btn-outline-success.w-100(href="/admin/offers")
                    i.fas.fa-cogs.me-2
                    | Manage Offers
              
              .col-md-3.mb-2
                a.btn.btn-outline-warning.w-100(href="/reports")
                  i.fas.fa-chart-bar.me-2
                  | View Reports

style.
  .card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
    transition: box-shadow 0.2s;
  }
  .card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  .badge {
    font-size: 0.75em;
  }
  .btn-group .btn:focus {
    box-shadow: none;
  }