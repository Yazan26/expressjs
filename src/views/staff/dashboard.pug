extends ../layout

block content
  section.mx-section.pt-0
    .d-flex.flex-wrap.align-items-center.justify-content-between.mb-4
      div
        h1.h3.fw-semibold.mb-1
          i.fas.fa-gauge-high.me-2.text-danger
          | Staff dashboard
        p.text-muted.mb-0 Welcome back - unlock offers, manage selections, and track your savings.
      .btn-group
        a.btn.btn-accent.rounded-pill(href='/staff/offers')
          i.fas.fa-tags.me-2
          | Film offers
        a.btn.btn-outline-light.rounded-pill(href='/staff/selections')
          i.fas.fa-star.me-2
          | My selections
  
  section.mx-section.pt-0
    .row.g-4
      .col-md-3
        .mx-card.h-100.p-4.text-center
          span.rounded-circle.bg-light.bg-opacity-10.d-inline-flex.align-items-center.justify-content-center.mb-3(style='width:58px;height:58px;')
            i.fas.fa-tags.text-danger
          h3.h4.fw-semibold.mb-1 #{offerStats && offerStats.available ? offerStats.available : 0}
          p.text-muted.small.mb-0 Available offers
      .col-md-3
        .mx-card.h-100.p-4.text-center
          span.rounded-circle.bg-light.bg-opacity-10.d-inline-flex.align-items-center.justify-content-center.mb-3(style='width:58px;height:58px;')
            i.fas.fa-star.text-warning
          h3.h4.fw-semibold.mb-1 #{selectionStats && selectionStats.total ? selectionStats.total : 0}
          p.text-muted.small.mb-0 My selections
      .col-md-3
        .mx-card.h-100.p-4.text-center
          span.rounded-circle.bg-light.bg-opacity-10.d-inline-flex.align-items-center.justify-content-center.mb-3(style='width:58px;height:58px;')
            i.fas.fa-sack-dollar.text-success
          h3.h4.fw-semibold.mb-1 $#{Number(selectionStats && (selectionStats.totalSavings || selectionStats.savings) ? (selectionStats.totalSavings || selectionStats.savings) : 0).toFixed(2)}
          p.text-muted.small.mb-0 Total savings
      .col-md-3
        .mx-card.h-100.p-4.text-center
          span.rounded-circle.bg-light.bg-opacity-10.d-inline-flex.align-items-center.justify-content-center.mb-3(style='width:58px;height:58px;')
            i.fas.fa-clock.text-info
          h3.h4.fw-semibold.mb-1 #{selectionStats && selectionStats.expiringSoon ? selectionStats.expiringSoon : 0}
          p.text-muted.small.mb-0 Expiring soon

  section.mx-section.pt-0
    .row.g-4
      .col-lg-8
        .mx-card.p-4.mb-4
          .d-flex.align-items-center.justify-content-between.mb-3
            h2.h5.fw-semibold.mb-0
              i.fas.fa-star.me-2
              | Active selections
            if activeSelections && activeSelections.length > 0
              span.badge.mx-pill.mx-pill-soft #{activeSelections.length}
          if activeSelections && activeSelections.length > 0
            .row.g-3
              each selection, index in activeSelections.slice(0, 4)
                .col-md-6
                  .mx-card.h-100.p-4.bg-dark.bg-opacity-25
                    h3.h6.fw-semibold.mb-2 #{selection.filmTitle}
                    .d-flex.justify-content-between.align-items-center
                      span.badge.bg-success.bg-opacity-25.text-success #{selection.discountPercent}% off
                      span.text-muted.small Expires #{new Date(selection.endDate).toLocaleDateString()}
                    p.text-muted.small.mt-3 Savings $#{Number(selection.savingsAmount || 0).toFixed(2)}
            if activeSelections.length > 4
              .text-center.mt-3
                a.btn.btn-outline-accent.rounded-pill.px-4(href='/staff/selections')
                  i.fas.fa-eye.me-2
                  | View all #{activeSelections.length}
          else
            .text-center.py-5
              i.fas.fa-star-half-stroke.fa-2x.text-muted.mb-3
              p.text-muted.mb-3 You have no active selections yet.
              a.btn.btn-accent.rounded-pill.px-4(href='/staff/offers')
                i.fas.fa-tags.me-2
                | Browse film offers
        .mx-card.p-4
          h2.h5.fw-semibold.mb-3
            i.fas.fa-gift.me-2
            | Latest film offers
          if recentOffers && recentOffers.length > 0
            .row.g-3
              each offer in recentOffers.slice(0, 4)
                .col-md-6
                  .mx-card.h-100.p-4.shadow-hover
                    .d-flex.justify-content-between.align-items-start.mb-2
                      h3.h6.fw-semibold.mb-0 #{offer.title}
                      span.badge.bg-primary.bg-opacity-25.text-primary #{offer.discount_percent}%
                    p.text-muted.small.mb-2 #{offer.category_name} | #{offer.rating}
                    .d-flex.justify-content-between.align-items-center.mb-3
                      span.text-muted.small
                        span.text-decoration-line-through.text-muted $#{Number(offer.rental_rate).toFixed(2)}
                        span.text-success.fw-semibold.ms-2 $#{Number(offer.discounted_price).toFixed(2)}
                      button.btn.btn-outline-accent.btn-sm.rounded-pill.select-offer-btn(data-film-id=offer.film_id data-film-title=offer.title)
                        i.fas.fa-plus.me-2
                        | Select
            .text-center.mt-3
              a.btn.btn-outline-light.rounded-pill.px-4(href='/staff/offers')
                i.fas.fa-eye.me-2
                | Browse all offers
          else
            .text-center.py-4
              i.fas.fa-gift.fa-2x.text-muted.mb-3
              p.text-muted.mb-0 No offers available right now. Please check back soon.
      .col-lg-4
        .mx-card.p-4.mb-4
          h2.h6.text-uppercase.text-muted.mb-3
            i.fas.fa-bolt.me-2
            | Quick actions
          .vstack.gap-3
            a.btn.btn-accent.rounded-pill(href='/staff/offers')
              i.fas.fa-tags.me-2
              | Browse film offers
            a.btn.btn-outline-light.rounded-pill(href='/staff/selections')
              i.fas.fa-star.me-2
              | My selections (#{selectionStats && selectionStats.total ? selectionStats.total : 0})
            a.btn.btn-outline-light.rounded-pill(href='/films')
              i.fas.fa-film.me-2
              | Explore catalogue
            a.btn.btn-outline-light.rounded-pill(href='/about')
              i.fas.fa-circle-info.me-2
              | Help & tips
        .mx-card.p-4.mb-4
          h2.h6.text-uppercase.text-muted.mb-3
            i.fas.fa-chart-pie.me-2
            | Savings snapshot
          if selectionStats
            .d-flex.justify-content-between.align-items-center.mb-2
              span.text-muted.small Original price
              span.fw-semibold $#{Number(selectionStats.totalOriginalPrice || 0).toFixed(2)}
            .d-flex.justify-content-between.align-items-center.mb-2
              span.text-muted.small You're saving
              span.text-success.fw-semibold $#{Number(selectionStats.totalSavings || selectionStats.savings || 0).toFixed(2)}
            .d-flex.justify-content-between.align-items-center.mb-3
              span.text-muted.small Avg. discount
              span.text-primary.fw-semibold #{selectionStats.averageDiscount || 0}%
            - const base = selectionStats.totalOriginalPrice || 0
            - const ratio = base ? Math.min(((selectionStats.totalSavings || 0) / base) * 100, 100) : 0
            .progress.bg-dark.bg-opacity-50(style='height:8px;')
              .progress-bar.bg-success(style=`width: ${ratio}%`)
            p.text-muted.small.text-center.mt-3 Savings rate
          else
            p.text-muted.small.mb-0 No savings data yet - add selections to start tracking.
        .mx-card.p-4
          h2.h6.text-uppercase.text-muted.mb-3
            i.fas.fa-lightbulb.me-2
            | Benefit tips
          ul.text-muted.small.mb-0
            li Select high-demand titles early - the best deals go fast.
            li Monitor expiry dates so you never miss a redemption window.
            li Mix genres to discover unexpected favorites for customers.
            li Pair staff offers with customer promos to stack savings.
            li Ask admin for new titles you would like to feature.

  script.
    document.addEventListener('DOMContentLoaded', function () {
      const selectButtons = document.querySelectorAll('.select-offer-btn');
      selectButtons.forEach(function (btn) {
        btn.addEventListener('click', function (event) {
          event.preventDefault();
          const filmId = this.dataset.filmId;
          const title = this.dataset.filmTitle;
          if (!confirm('Select "' + title + '" for your employee benefits?')) {
            return;
          }
          const original = this.innerHTML;
          const button = this;
          button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Selecting';
          button.disabled = true;
          fetch('/staff/offers/select', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ film_id: filmId })
          })
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (data && data.success) {
                var savings = data.data && data.data.savings ? data.data.savings : '0.00';
                alert('"' + title + '" added to your selections. Savings: $' + savings);
                window.location.reload();
              } else {
                throw new Error(data && data.message ? data.message : 'Selection failed');
              }
            })
            .catch(function (error) {
              console.error(error);
              alert('Error selecting offer: ' + error.message);
              button.innerHTML = original;
              button.disabled = false;
            });
        });
      });
    });
