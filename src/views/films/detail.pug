extends ../layout

block content
  section.mx-section.pt-0
    a.btn.btn-outline-light.btn-sm.rounded-pill.mb-3(href='/films')
      i.fas.fa-arrow-left.me-2
      | Back to catalogue
    if error && error.length > 0
      .alert.alert-danger.alert-dismissible.fade.show
        i.fas.fa-triangle-exclamation.me-2
        | #{error}
        button.btn-close(type='button' data-bs-dismiss='alert')
    .row.g-4
      .col-xl-8
        .mx-card.p-5
          .row.g-4
            .col-md-4
              .d-flex.align-items-center.justify-content-center.rounded-4.bg-light.bg-opacity-10(style='min-height: 320px;')
                .text-center.text-muted
                  i.fas.fa-film.fa-2x.mb-3
                  p.text-muted.mb-0 #{film.title}
            .col-md-8
              .d-flex.justify-content-between.align-items-start.mb-3
                div
                  h1.h3.fw-semibold.mb-1 #{film.title}
                  if film.releaseYear || film.release_year
                    p.text-muted.mb-0 #{film.releaseYear || film.release_year}
                span.badge.mx-pill.mx-pill-soft.fs-6 #{film.rating}
              .row.g-3.mb-4
                if film.category
                  .col-sm-6
                    span.text-muted.small.text-uppercase Category
                    div.mt-2.span.badge.bg-light.bg-opacity-10.text-light.rounded-pill #{film.category}
                if film.language
                  .col-sm-6
                    span.text-muted.small.text-uppercase Language
                    div.mt-2 #{film.language}
                if film.length
                  .col-sm-6
                    span.text-muted.small.text-uppercase Runtime
                    div.mt-2 #{film.length} minutes
                if film.rentalDuration
                  .col-sm-6
                    span.text-muted.small.text-uppercase Rental period
                    div.mt-2 #{film.rentalDuration} days
              .row.g-3.mb-4
                if film.rentalRate || film.rental_rate
                  .col-sm-6
                    span.text-muted.small.text-uppercase Rental price
                    .mt-2
                      if film.discounted_price
                        span.text-muted.text-decoration-line-through.d-block
                          | $#{Number(film.rentalRate || film.rental_rate).toFixed(2)}
                        span.text-success.fw-semibold
                          | $#{Number(film.discounted_price).toFixed(2)}
                      else
                        span.text-success.fw-semibold
                          | $#{Number(film.rentalRate || film.rental_rate).toFixed(2)}
                if film.replacementCost || film.replacement_cost
                  .col-sm-6
                    span.text-muted.small.text-uppercase Replacement cost
                    div.mt-2.text-warning.fw-semibold
                      | $#{Number(film.replacementCost || film.replacement_cost).toFixed(2)}
              if film.description
                h2.h6.text-uppercase.text-muted.mb-2 Synopsis
                p.text-muted.mb-4 #{film.description}
              if film.specialFeatures || film.special_features
                h2.h6.text-uppercase.text-muted.mb-2 Special features
                p.text-muted.small #{film.specialFeatures || film.special_features}
      .col-xl-4
        if actors && actors.length > 0
          .mx-card.p-4.mb-4
            h2.h6.text-uppercase.text-muted.mb-3
              i.fas.fa-users.me-2
              | Cast highlights
            .row.g-3
              each actor in actors.slice(0, 8)
                .col-6
                  span.text-muted.small #{actor.actorName}
              if actors.length > 8
                .col-12.text-center
                  span.text-muted.small …and #{actors.length - 8} more
        if authenticated && user
          .mx-card.p-4
            h2.h6.text-uppercase.text-muted.mb-3
              i.fas.fa-star.me-2
              | Quick actions
            if user.role === 'customer'
              if film.available_copies && film.available_copies > 0
                form(method='POST' action=`/films/${film.film_id}/rent`)
                  button.btn.btn-accent.btn-lg.w-100.rounded-pill(type='submit' id='rentButton')
                    i.fas.fa-cart-plus.me-2
                    | Rent now ($#{Number(film.discounted_price || film.rentalRate || film.rental_rate).toFixed(2)})
                p.text-muted.small.text-center.mt-3 #{film.available_copies} of #{film.total_copies} copies available
              else
                button.btn.btn-outline-light.btn-lg.w-100.rounded-pill(disabled)
                  i.fas.fa-circle-xmark.me-2
                  | Currently unavailable
                p.text-muted.small.text-center.mt-3 All #{film.total_copies || 0} copies are rented
            else if user.role === 'admin'
              a.btn.btn-outline-accent.w-100.rounded-pill(href='/admin/films')
                i.fas.fa-screwdriver-wrench.me-2
                | Manage inventory
  if recommendations && (recommendations.byCategory.length > 0 || recommendations.byActor.length > 0)
    section.mx-section.pt-0
      h2.h4.fw-semibold.mb-4
        i.fas.fa-thumbs-up.me-2
        | You may also like
      if recommendations.byCategory && recommendations.byCategory.length > 0
        h3.h6.text-uppercase.text-muted.mb-3
          i.fas.fa-tags.me-2
          | More #{film.category} films
        .row.row-cols-1.row-cols-sm-2.row-cols-lg-4.g-3.mb-4
          each rec in recommendations.byCategory.slice(0, 4)
            .col
              .mx-card.h-100.p-4.shadow-hover
                h4.h6.fw-semibold.mb-1
                  a.text-decoration-none(href=`/films/${rec.filmId}`)= rec.title
                if rec.releaseYear
                  p.text-muted.small.mb-1 #{rec.releaseYear}
                if rec.rating
                  span.badge.mx-pill.mx-pill-soft #{rec.rating}
      if recommendations.byActor && recommendations.byActor.length > 0
        h3.h6.text-uppercase.text-muted.mb-3
          i.fas.fa-user.me-2
          | Films featuring similar cast
        .row.row-cols-1.row-cols-sm-2.row-cols-lg-4.g-3
          each rec in recommendations.byActor.slice(0, 4)
            .col
              .mx-card.h-100.p-4.shadow-hover
                h4.h6.fw-semibold.mb-1
                  a.text-decoration-none(href=`/films/${rec.filmId}`)= rec.title
                if rec.releaseYear
                  p.text-muted.small.mb-1 #{rec.releaseYear}
                if rec.rating
                  span.badge.mx-pill.mx-pill-soft #{rec.rating}
                if rec.category
                  p.text-muted.small.mb-0 #{rec.category}
  if !authenticated
    section.mx-section.pt-0
      .mx-card.p-5.text-center.bg-dark.bg-opacity-50.border-0
        h2.h5.fw-semibold.mb-2 Want to rent this film?
        p.text-muted.mb-4 Create a free account or sign in to add this title to your queue.
        .d-flex.justify-content-center.gap-3
          a.btn.btn-accent.rounded-pill.px-4(href='/auth/register')
            i.fas.fa-user-plus.me-2
            | Register
          a.btn.btn-outline-light.rounded-pill.px-4(href='/auth/login')
            i.fas.fa-arrow-right-to-bracket.me-2
            | Login

  script.
    document.addEventListener('DOMContentLoaded', function () {
      const rentButton = document.getElementById('rentButton');
      if (!rentButton) return;
      const form = rentButton.closest('form');
      if (!form) return;
      form.addEventListener('submit', function () {
        rentButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Processing';
        rentButton.disabled = true;
      });
    });
