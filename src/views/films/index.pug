extends ../layout

block content
  section.mx-section.pt-0
    .row.g-4
      .col-xl-3
        .mx-card.p-4
          h2.h6.text-uppercase.text-muted.mb-3
            i.fas.fa-magnifying-glass.me-2
            | Search & filters
          form(method='GET' action='/films')
            .mb-3
              label.form-label.fw-semibold(for='q') Title or keyword
              input.form-control(type='text' id='q' name='q' value=searchQuery placeholder='Search films...')
            .mb-3
              label.form-label.fw-semibold(for='category') Category
              select.form-select(id='category' name='category')
                option(value='') All categories
                each category in categories
                  option(value=category.category_id selected=currentCategory == category.category_id)= category.name
            .mb-3
              label.form-label.fw-semibold(for='rating') Rating
              select.form-select(id='rating' name='rating')
                option(value='') All ratings
                each rating in ratings
                  option(value=rating selected=currentRating == rating)= rating
            .mb-3
              label.form-label.fw-semibold(for='sort') Sort by
              select.form-select(id='sort' name='sort')
                option(value='title' selected=currentSort === 'title') Title (A to Z)
                option(value='discount_desc' selected=currentSort === 'discount_desc') Discount (High to Low)
                option(value='discount_asc' selected=currentSort === 'discount_asc') Discount (Low to High)
                option(value='price_asc' selected=currentSort === 'price_asc') Price (Low to High)
                option(value='price_desc' selected=currentSort === 'price_desc') Price (High to Low)
            button.btn.btn-accent.w-100.rounded-pill(type='submit')
              i.fas.fa-magnifying-glass.me-2
              | Apply filters
        if pagination
          .mx-card.p-4.mt-4
            h3.h6.text-uppercase.text-muted.mb-2 Results
            p.text-muted.mb-0 #{pagination.total} films found
            if currentSearch || currentCategory != 'all' || currentRating != 'all'
              p.text-muted.small.mb-0 Showing page #{pagination.currentPage} of #{pagination.totalPages}
      .col-xl-9
        if error && error.length > 0
          .alert.alert-danger.alert-dismissible.fade.show
            i.fas.fa-triangle-exclamation.me-2
            | #{error}
            button.btn-close(type='button' data-bs-dismiss='alert')
        .d-flex.flex-wrap.align-items-center.justify-content-between.mb-4
          div
            h1.h3.fw-semibold.mb-1 Browse films
            if searchQuery
              p.text-muted.mb-0 Results for "#{searchQuery}"
            else
              p.text-muted.mb-0 Discover feature selections and curated categories.
          .btn-group
            button.btn.btn-outline-accent.active(type='button')
              i.fas.fa-grid-2.me-2
              | Grid
            button.btn.btn-outline-light(type='button')
              i.fas.fa-list.me-2
              | List
        if films && films.length > 0
          .row.row-cols-1.row-cols-md-2.row-cols-xl-3.g-4
            each film in films
              .col
                .mx-card.h-100.p-4.shadow-hover
                  .d-flex.justify-content-between.align-items-start.mb-3
                    h2.h5.fw-semibold.mb-0
                      a.text-decoration-none(href=`/films/${film.filmId}`)= film.title
                    span.badge.mx-pill.mx-pill-soft #{film.rating}
                  if film.category
                    p.text-muted.small.mb-2
                      i.fas.fa-tags.me-2
                      | #{film.category}
                  if film.releaseYear
                    p.text-muted.small.mb-3
                      i.fas.fa-calendar-days.me-2
                      | #{film.releaseYear}
                  if film.description
                    p.text-muted.flex-grow-1.mb-4= film.description.length > 120 ? film.description.substring(0, 120) + '...' : film.description
                  if film.rentalRate
                    .d-flex.justify-content-between.align-items-center.mb-4
                      span.text-muted.small Pricing
                      if film.discounted_price
                        div
                          span.text-muted.text-decoration-line-through.d-block
                            | $#{Number(film.rentalRate).toFixed(2)}
                          span.text-success.fw-semibold
                            | $#{Number(film.discounted_price).toFixed(2)}
                      else
                        span.text-success.fw-semibold
                          | $#{Number(film.rentalRate).toFixed(2)}
                  a.btn.btn-accent.rounded-pill.w-100(href=`/films/${film.filmId}`)
                    i.fas.fa-eye.me-2
                    | View details
        else
          .mx-card.p-5.text-center
            i.fas.fa-film.fa-3x.text-muted.mb-3
            h2.h5.fw-semibold.mb-2 No films found
            p.text-muted.mb-4 #{searchQuery ? `No films match "${searchQuery}".` : 'Check back soon for new titles.'}
            a.btn.btn-outline-accent.rounded-pill(href='/films') Clear filters
        if pagination && pagination.totalPages > 1
          nav.mt-4(aria-label='Films pagination')
            .row.align-items-center.g-3
              .col-md-4
                p.text-muted.small.mb-0 Showing #{((pagination.page - 1) * pagination.limit) + 1} - #{Math.min(pagination.page * pagination.limit, pagination.total)} of #{pagination.total}
              .col-md-8
                ul.pagination.justify-content-md-end.justify-content-center.mb-0
                  if pagination.hasPrev
                    li.page-item
                      a.page-link(href=`/films?${new URLSearchParams({...req.query, page: pagination.page - 1}).toString()}`)
                        i.fas.fa-chevron-left.me-2
                        | Prev
                  else
                    li.page-item.disabled
                      span.page-link
                        i.fas.fa-chevron-left.me-2
                        | Prev
                  - var startPage = Math.max(1, pagination.page - 2)
                  - var endPage = Math.min(pagination.totalPages, pagination.page + 2)
                  if startPage > 1
                    li.page-item
                      a.page-link(href=`/films?${new URLSearchParams({...req.query, page: 1}).toString()}`) 1
                    if startPage > 2
                      li.page-item.disabled
                        span.page-link ...
                  - for (var p = startPage; p <= endPage; p++)
                    li.page-item(class=p === pagination.page ? 'active' : '')
                      a.page-link(href=`/films?${new URLSearchParams({...req.query, page: p}).toString()}`)= p
                  if endPage < pagination.totalPages
                    if endPage < pagination.totalPages - 1
                      li.page-item.disabled
                        span.page-link ...
                    li.page-item
                      a.page-link(href=`/films?${new URLSearchParams({...req.query, page: pagination.totalPages}).toString()}`)= pagination.totalPages
                  if pagination.hasNext
                    li.page-item
                      a.page-link(href=`/films?${new URLSearchParams({...req.query, page: pagination.page + 1}).toString()}`)
                        | Next
                        i.fas.fa-chevron-right.ms-2
                  else
                    li.page-item.disabled
                      span.page-link
                        | Next
                        i.fas.fa-chevron-right.ms-2
