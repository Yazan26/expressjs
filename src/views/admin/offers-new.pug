extends ../layout

block content
  .container-fluid
    // Page Header
    .row.mb-4
      .col-lg-8
        h1.h2.mb-1
          i.fas.fa-plus.me-2.text-success
          | Create New Offer
        p.text-muted Select films and configure offer details
      
      .col-lg-4.text-lg-end
        .btn-group
          a.btn.btn-outline-secondary(href="/admin/offers")
            i.fas.fa-arrow-left.me-2
            | Back to Offers
          a.btn.btn-outline-primary(href="/admin/films") Film Management

    // Success/Error Messages
    if success
      .alert.alert-success.alert-dismissible.fade.show
        i.fas.fa-check-circle.me-2
        | #{success}
        button.btn-close(type="button", data-bs-dismiss="alert")

    if error
      .alert.alert-danger.alert-dismissible.fade.show
        i.fas.fa-exclamation-triangle.me-2
        | #{error}
        button.btn-close(type="button", data-bs-dismiss="alert")

    // Search and Filter Section
    .card.mb-4
      .card-body
        form.row.g-3(method="GET", action="/admin/offers/new")
          .col-md-4
            label.form-label(for="search") Search Films
            input.form-control#search(type="text", name="search", placeholder="Enter film title...", value=searchParams.search)
          
          .col-md-3
            label.form-label(for="category") Category
            select.form-select#category(name="category")
              option(value="all", selected=searchParams.category === 'all') All Categories
              if categories
                each category in categories
                  option(value=category.category_id, selected=searchParams.category == category.category_id) #{category.name}
          
          .col-md-2
            label.form-label &nbsp;
            .d-grid
              button.btn.btn-primary(type="submit")
                i.fas.fa-search.me-2
                | Search
          
          .col-md-3
            label.form-label &nbsp;
            .d-grid
              a.btn.btn-outline-secondary(href="/admin/offers/new")
                i.fas.fa-times.me-2
                | Clear

    // Offer Creation Form
    if films && films.length > 0
      form#offerForm(method="POST", action="/admin/offers/new")
        .row
          // Film Selection
          .col-lg-8
            .card
              .card-header
                .d-flex.justify-content-between.align-items-center
                  h5.card-title.mb-0 
                    i.fas.fa-film.me-2
                    | Select Films
                  .form-check
                    input.form-check-input#selectAll(type="checkbox")
                    label.form-check-label(for="selectAll") Select All
              
              .card-body.p-0
                .table-responsive
                  table.table.table-hover.mb-0
                    thead.table-light
                      tr
                        th 
                          input.form-check-input(type="checkbox", id="selectAllTable")
                        th Film Title
                        th Category
                        th Rating
                        th Rental Rate
                        th Runtime
                    tbody
                      each film in films
                        tr
                          td
                            input.form-check-input.film-checkbox(type="checkbox", name="filmIds", value=film.film_id)
                          td
                            .fw-bold #{film.title}
                          td #{film.category_name || 'Uncategorized'}
                          td
                            .badge.bg-info #{film.rating}
                          td $#{parseFloat(film.rental_rate).toFixed(2)}
                          td #{film.length || 0} min

            // Pagination
            if pagination && pagination.totalPages > 1
              nav.mt-4
                .d-flex.justify-content-between.align-items-center
                  .text-muted
                    | Showing #{films.length} of #{pagination.totalItems} films
                  
                  ul.pagination.pagination-sm.mb-0
                    if pagination.hasPrevPage
                      li.page-item
                        a.page-link(href=`/admin/offers/new?page=${pagination.page - 1}&search=${searchParams.search}&category=${searchParams.category}`) Previous
                    else
                      li.page-item.disabled
                        span.page-link Previous
                    
                    - var startPage = Math.max(1, pagination.page - 2)
                    - var endPage = Math.min(pagination.totalPages, pagination.page + 2)
                    
                    if startPage > 1
                      li.page-item
                        a.page-link(href=`/admin/offers/new?page=1&search=${searchParams.search}&category=${searchParams.category}`) 1
                      if startPage > 2
                        li.page-item.disabled
                          span.page-link ...
                    
                    - for (var p = startPage; p <= endPage; p++)
                      li.page-item(class=p === pagination.page ? 'active' : '')
                        a.page-link(href=`/admin/offers/new?page=${p}&search=${searchParams.search}&category=${searchParams.category}`) #{p}
                    
                    if endPage < pagination.totalPages
                      if endPage < pagination.totalPages - 1
                        li.page-item.disabled
                          span.page-link ...
                      li.page-item
                        a.page-link(href=`/admin/offers/new?page=${pagination.totalPages}&search=${searchParams.search}&category=${searchParams.category}`) #{pagination.totalPages}
                    
                    if pagination.hasNextPage
                      li.page-item
                        a.page-link(href=`/admin/offers/new?page=${pagination.page + 1}&search=${searchParams.search}&category=${searchParams.category}`) Next
                    else
                      li.page-item.disabled
                        span.page-link Next

          // Offer Configuration
          .col-lg-4
            .card
              .card-header
                h5.card-title.mb-0
                  i.fas.fa-cog.me-2
                  | Offer Configuration
              
              .card-body
                .mb-3
                  label.form-label(for="discountPercent") Discount Percentage *
                  .input-group
                    input.form-control#discountPercent(type="number", name="discountPercent", required, min="1", max="99", step="0.1", placeholder="15.0")
                    .input-group-text %
                  .form-text Enter discount percentage (e.g., 15 for 15%)
                
                .mb-3
                  label.form-label(for="description") Description
                  textarea.form-control#description(name="description", rows="3", placeholder="Optional description for this offer")
                
                hr
                
                .d-grid
                  button.btn.btn-success.btn-lg#createOfferBtn(type="submit", disabled)
                    i.fas.fa-plus.me-2
                    | Create Offer

    else
      .card.text-center.py-5
        .card-body
          i.fas.fa-film.fa-3x.text-muted.mb-3
          h4.text-muted No Available Films
          p.text-muted
            if searchParams.search || searchParams.category !== 'all'
              | No films match your current search criteria.
              br
              a.btn.btn-outline-primary.mt-2(href="/admin/offers/new") Clear Search
            else
              | All films already have active offers or no films exist.
              br  
              a.btn.btn-outline-secondary.mt-2(href="/admin/offers") Back to Offers

  script.
    // Handle select all functionality
    document.getElementById('selectAll')?.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.film-checkbox');
      checkboxes.forEach(checkbox => checkbox.checked = this.checked);
      updateCreateButton();
    });
    
    document.getElementById('selectAllTable')?.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.film-checkbox');
      checkboxes.forEach(checkbox => checkbox.checked = this.checked);
      updateCreateButton();
    });
    
    // Handle individual checkbox changes
    document.querySelectorAll('.film-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', updateCreateButton);
    });
    
    function updateCreateButton() {
      const checkedBoxes = document.querySelectorAll('.film-checkbox:checked');
      const createBtn = document.getElementById('createOfferBtn');
      if (createBtn) {
        createBtn.disabled = checkedBoxes.length === 0;
      }
    }
    
    // Initialize button state
    updateCreateButton();

  // Custom CSS
  style.
    .table th { 
      border-top: none; 
      font-weight: 600;
      font-size: 0.9em;
    }
    .card:hover { 
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); 
    }
    .pagination .page-link {
      border-color: #dee2e6;
    }
    .pagination .page-item.active .page-link {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .film-checkbox:checked + .fw-bold {
      color: #0d6efd !important;
    }