extends ../layout

block content
  .container-fluid
    // Page Header
    .row.mb-4
      .col-lg-8
        h1.h2.mb-1
          i.fas.fa-users-cog.me-2.text-info
          | Customer Insights Report
        p.text-muted Understand customer behavior, preferences, and lifetime value
      
      .col-lg-4.text-lg-end
        .btn-group
          a.btn.btn-outline-primary(href="/reports") 
            i.fas.fa-chart-bar.me-2
            | All Reports
          a.btn.btn-outline-success(href="/customer") 
            i.fas.fa-users.me-2
            | Manage Customers

    // Summary Cards
    if summary
      .row.mb-4
        .col-md-6.mb-3
          .card.bg-primary.bg-gradient.text-white
            .card-body.text-center
              .h3.mb-1 #{summary.totalCustomers || 0}
              .small Active Customers Analyzed
        .col-md-6.mb-3
          .card.bg-success.bg-gradient.text-white
            .card-body.text-center
              .h3.mb-1 $#{summary.avgLifetimeValue || 0}
              .small Average Customer Lifetime Value

    // Customer Segments
    if segments
      .row.mb-4
        .col-12
          .card
            .card-header
              h5.card-title.mb-0
                i.fas.fa-chart-pie.me-2
                | Customer Segmentation
            .card-body
              .row
                .col-md-4.mb-3
                  .card.border-success.h-100
                    .card-body.text-center
                      .display-6.text-success.mb-2
                        i.fas.fa-crown
                      h4.card-title #{segments.Premium || 0}
                      p.card-text Premium Customers
                      .small.text-muted $100+ lifetime value
                
                .col-md-4.mb-3
                  .card.border-primary.h-100
                    .card-body.text-center
                      .display-6.text-primary.mb-2
                        i.fas.fa-user
                      h4.card-title #{segments.Regular || 0}
                      p.card-text Regular Customers
                      .small.text-muted $50-$99 lifetime value
                
                .col-md-4.mb-3
                  .card.border-warning.h-100
                    .card-body.text-center
                      .display-6.text-warning.mb-2
                        i.fas.fa-user-clock
                      h4.card-title #{segments.Occasional || 0}
                      p.card-text Occasional Customers
                      .small.text-muted Under $50 lifetime value

    // Filters
    .row.mb-4
      .col-12
        .card
          .card-header
            h5.card-title.mb-0
              i.fas.fa-filter.me-2
              | Filter Customers
          .card-body
            form.row.g-3(method="GET", action="/reports/customer-insights")
              .col-md-3
                label.form-label Customer Segment
                select.form-select(name="segment")
                  option(value="all", selected=filters.segment === 'all') All Segments
                  option(value="Premium", selected=filters.segment === 'Premium') Premium ($100+)
                  option(value="Regular", selected=filters.segment === 'Regular') Regular ($50-$99)
                  option(value="Occasional", selected=filters.segment === 'Occasional') Occasional (<$50)
              
              .col-md-3
                label.form-label Sort By
                select.form-select(name="sort")
                  option(value="value", selected=filters.sort === 'value') Lifetime Value
                  option(value="rentals", selected=filters.sort === 'rentals') Total Rentals
                  option(value="recent", selected=filters.sort === 'recent') Most Recent Activity
                  option(value="name", selected=filters.sort === 'name') Customer Name
              
              .col-md-3
                label.form-label Show Results
                select.form-select(name="limit")
                  option(value="50", selected=filters.limit == 50) Top 50
                  option(value="100", selected=filters.limit == 100) Top 100
                  option(value="200", selected=filters.limit == 200) Top 200
              
              .col-md-3.d-flex.align-items-end
                button.btn.btn-primary.w-100(type="submit")
                  i.fas.fa-search.me-2
                  | Apply Filters

    // Customer Details Table
    if customers && customers.length > 0
      .row
        .col-12
          .card
            .card-header
              h5.card-title.mb-0
                i.fas.fa-table.me-2
                | Customer Details & Analytics
            .card-body
              .table-responsive
                table.table.table-hover
                  thead.table-dark
                    tr
                      th Customer
                      th Email
                      th Member Since
                      th Total Rentals
                      th Total Spent
                      th Avg Rental Cost
                      th Last Activity
                      th Segment
                      th Status
                  tbody
                    for customer in customers
                      tr
                        td
                          strong #{customer.customer_name}
                        td.small #{customer.email}
                        td.small #{new Date(customer.create_date).toLocaleDateString()}
                        td.text-center #{customer.total_rentals || 0}
                        td.text-success
                          strong $#{parseFloat(customer.total_spent || 0).toFixed(2)}
                        td.text-info $#{parseFloat(customer.avg_rental_cost || 0).toFixed(2)}
                        td.small
                          if customer.last_rental_date
                            #{new Date(customer.last_rental_date).toLocaleDateString()}
                            if customer.days_since_last_rental
                              .small.text-muted (#{customer.days_since_last_rental} days ago)
                          else
                            .text-muted No rentals
                        td
                          if customer.customer_segment === 'Premium'
                            .badge.bg-success Premium
                          else if customer.customer_segment === 'Regular'
                            .badge.bg-primary Regular
                          else
                            .badge.bg-warning Occasional
                        td
                          - var daysSinceActivity = customer.days_since_last_rental || 0
                          if daysSinceActivity <= 30
                            .badge.bg-success Active
                          else if daysSinceActivity <= 90
                            .badge.bg-warning Inactive
                          else
                            .badge.bg-danger At Risk

    else
      .row
        .col-12
          .card
            .card-body.text-center.py-5
              .mb-4
                i.fas.fa-users-cog.fa-4x.text-muted
              h4.text-muted No Customer Data Available
              p.text-muted No customer insights data found for the selected criteria.

    // Customer Insights & Recommendations
    .row.mt-4
      .col-md-6.mb-4
        .card.border-info
          .card-header.bg-info.text-white
            h6.card-title.mb-0
              i.fas.fa-lightbulb.me-2
              | Key Insights
          .card-body
            if customers && customers.length > 0
              - var totalSpent = customers.reduce((sum, c) => sum + (c.total_spent || 0), 0)
              - var avgRentals = customers.reduce((sum, c) => sum + (c.total_rentals || 0), 0) / customers.length
              - var premiumCount = customers.filter(c => c.customer_segment === 'Premium').length
              - var atRiskCount = customers.filter(c => (c.days_since_last_rental || 0) > 90).length
              
              ul.list-unstyled.mb-0
                li.mb-2
                  i.fas.fa-star.text-warning.me-2
                  strong #{premiumCount} premium customers (#{((premiumCount/customers.length)*100).toFixed(1)}%)
                li.mb-2
                  i.fas.fa-chart-line.text-success.me-2
                  | Average rentals per customer: #{avgRentals.toFixed(1)}
                li.mb-2
                  i.fas.fa-exclamation-triangle.text-danger.me-2
                  | #{atRiskCount} customers at risk of churning
                li
                  i.fas.fa-dollar-sign.text-success.me-2
                  | Total customer value: $#{totalSpent.toFixed(2)}
            else
              p.text-muted No insights available without customer data.

      .col-md-6.mb-4
        .card.border-warning
          .card-header.bg-warning.text-dark
            h6.card-title.mb-0
              i.fas.fa-bullhorn.me-2
              | Recommendations
          .card-body
            ul.list-unstyled.mb-0
              li.mb-2
                i.fas.fa-envelope.text-primary.me-2
                | Send re-engagement emails to customers inactive >90 days
              li.mb-2
                i.fas.fa-gift.text-success.me-2
                | Offer loyalty rewards to premium customers
              li.mb-2
                i.fas.fa-percentage.text-info.me-2
                | Create targeted promotions for occasional customers
              li
                i.fas.fa-phone.text-warning.me-2
                | Personal outreach to at-risk high-value customers

    // Export Options
    .row.mt-4
      .col-12
        .card.bg-light
          .card-body
            .row
              .col-md-8
                h6.card-title
                  i.fas.fa-download.me-2
                  | Export Customer Data
                p.card-text.text-muted Download customer insights for CRM integration or marketing campaigns.
              .col-md-4.text-end
                .btn-group
                  button.btn.btn-outline-success.btn-sm(onclick="exportReport('csv')")
                    i.fas.fa-file-csv.me-1
                    | CSV
                  button.btn.btn-outline-primary.btn-sm(onclick="exportReport('excel')")
                    i.fas.fa-file-excel.me-1
                    | Excel

script.
  function exportReport(format) {
    alert('Exporting customer insights in ' + format.toUpperCase() + ' format... (Feature coming soon)');
  }

style.
  .table th
    font-size: 0.875rem
    white-space: nowrap
  .table td
    font-size: 0.875rem
  .card
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075)